---

- name: Remove unnecessary self-signed SSL files
  file:
    path: "/usr/local/ispconfig/interface/ssl/{{ item }}"
    state: absent
  with_items:
    - ispserver.csr
    - ispserver.key.secure
    - ispserver.crt
    - ispserver.key

- name: Create symlinks to Let's Encrypt SSL files
  file:
    src: '/etc/letsencrypt/live/{{ item.domains.0 }}/fullchain.pem'
    dest: '/usr/local/ispconfig/interface/ssl/ispserver.crt'
    state: link
    follow: yes
  with_items: "{{ certbot.certs }}"

- name: Create symlinks to Let's Encrypt SSL files
  file:
    src: '/etc/letsencrypt/live/{{ item.domains.0 }}/privkey.pem'
    dest: '/usr/local/ispconfig/interface/ssl/ispserver.key'
    state: link
    follow: yes
  with_items: "{{ certbot.certs }}"

- name: Start services after cert has been generated
  service:
    name: "{{ certbot.create_standalone_stop_services }}"
    state: started
  when: not letsencrypt_cert.stat.exists
